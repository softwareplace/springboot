#!/bin/sh

set -e

buildTag=$1

if [ -z "$buildTag" ]; then
  buildTag=$(git describe --tags --abbrev=0)
fi

if [ -z "$buildTag" ]; then
  buildTag="1.0.0-SNAPSHOT"
fi

JVM_ARGS="-Xmx2g -Xms1g -XX:MaxMetaspaceSize=1g -Dfile.encoding=UTF-8 -XX:+UseG1GC -XX:InitiatingHeapOccupancyPercent=75"

echo "Publishing $buildTag"

./gradlew clean --parallel -Dorg.gradle.jvmargs="$JVM_ARGS" \
    versions:assemble versions:publishToMavenLocal \
    build-configuration:assemble build-configuration:publishToMavenLocal \
    utils:assemble utils:publishToMavenLocal \
    java:assemble java:publishToMavenLocal \
    kotlin:assemble kotlin:publishToMavenLocal \
    data-commons:assemble data-commons:publishToMavenLocal \
    starter:assemble starter:publishToMavenLocal \
    security:assemble security:publishToMavenLocal \
    graalvm:assemble graalvm:publishToMavenLocal \
    :assemble :publishToMavenLocal \
    -Pgroup=com.github.softwareplace.springboot \
    --refresh-dependencies -Pversion="$buildTag" \
    --stacktrace

./gradlew clean --parallel -Dorg.gradle.jvmargs="$JVM_ARGS" \
    :assemble :publishToMavenLocal --parallel -Dorg.gradle.jvmargs="$JVM_ARGS" \
    -Pgroup=com.github.softwareplace.springboot \
    --refresh-dependencies -Pversion="$buildTag" \
    --stacktrace --parallel \
    -Dorg.gradle.jvmargs="$JVM_ARGS"
