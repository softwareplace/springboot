#!/bin/sh

set -e

java --version

buildTargetTag=$1

echo "Specified tag $buildTargetTag"

if [ -z "$buildTargetTag" ]; then
  buildTargetTag=$(git describe --tags --abbrev=0)
fi

if [ -z "$buildTargetTag" ]; then
  buildTargetTag="1.0.0-SNAPSHOT"
fi


publishToLocal() {
  echo "BUILD_RUNNER:$1 $buildTargetTag"
  if ! ./gradlew clean --parallel \
        "$1:assemble" "$1:publishToMavenLocal" --stacktrace \
        -Pgroup=com.github.softwareplace.springboot --refresh-dependencies -Pversion="$buildTargetTag" --stacktrace;
  then
    echo "BUILD_RUNNER:$1 failed $buildTargetTag"
    exit 1
  fi
}

publishToLocal version
publishToLocal utils
publishToLocal build-configuration
publishToLocal java
publishToLocal kotlin
publishToLocal graalvm
publishToLocal plugins
publishToLocal data-commons
publishToLocal starter
publishToLocal security
