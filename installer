#!/bin/sh

set -e

java --version

buildTargetTag=$1

echo "Specified tag $buildTargetTag"

if [ -z "$buildTargetTag" ]; then
  buildTargetTag=$(git describe --tags --abbrev=0)
fi

if [ -z "$buildTargetTag" ]; then
  buildTargetTag="1.0.0-SNAPSHOT"
fi

cp ./settings/plugins-settings.gradle.kts ./settings.gradle.kts

if ! ./gradlew clean --parallel --stacktrace \
      -Pgroup=com.github.softwareplace.springboot \
      --refresh-dependencies \
      -Pversion="$buildTargetTag" \
      versions:publishToMavenLocal \
      utils:publishToMavenLocal \
      build-configuration:publishToMavenLocal \
      java:publishToMavenLocal \
      kotlin:publishToMavenLocal \
      :publishToMavenLocal;
then
  echo "Publish sub-plugins failed $buildTargetTag"
  exit 1
fi

cp ./settings/libs-settings.gradle.kts ./settings.gradle.kts

publishToLocal() {
  echo "BUILD_RUNNER:$1 $buildTargetTag"
  if ! ./gradlew clean --parallel \
        "$1:assemble" "$1:publishToMavenLocal" --stacktrace \
        -Pgroup=com.github.softwareplace.springboot --refresh-dependencies -Pversion="$buildTargetTag" --stacktrace;
  then
    echo "BUILD_RUNNER:$1 failed $buildTargetTag"
    exit 1
  fi
}

publishToLocal data-commons
publishToLocal starter
publishToLocal security

cp ./settings/default-settings.gradle.kts ./settings.gradle.kts
